import{o as t,c as i,w as e,n,a as r,x as o,C as s,E as h,i as a,J as _}from"./index-7053ad66.js";import{_ as l}from"./_plugin-vue_export-helper.1b428a4d.js";
/*!
* RawCanvas of VISLite JavaScript Library v1.1.0
* git+https://github.com/oi-contrib/VISLite.git
*/var u=function(t,i){return(u=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var e in i)Object.prototype.hasOwnProperty.call(i,e)&&(t[e]=i[e])})(t,i)};"function"==typeof SuppressedError&&SuppressedError;var p=function(t,i,e,n,r){var o=Math.cos(e),s=Math.sin(e);return[+((n-t)*o-(r-i)*s+t).toFixed(7),+((n-t)*s+(r-i)*o+i).toFixed(7)]},c=function(t,i,e,n,r){return t.beginPath(),t.translate(e,n),t.rotate(r),t.font=i.fontStyle+" "+i.fontWeight+" "+i.fontSize+"px "+i.fontFamily,t},f=function(t,i,e,n,r,o,s,h){if(r>o){var a=r;r=o,o=a}return s%=2*Math.PI,h>=1.999999*Math.PI||h<=1.999999*-Math.PI?h=2*Math.PI:h%=2*Math.PI,function(s,h,a,_,l,u,c){h<0&&(s+=h,h*=-1);var f,g=[];f=p(0,0,s,l,0),g[0]=f[0],g[1]=f[1],f=p(0,0,h,f[0],f[1]),g[2]=f[0],g[3]=f[1],f=p(0,0,s,u,0),g[4]=f[0],g[5]=f[1],f=p(0,0,h,f[0],f[1]),g[6]=f[0],g[7]=f[1],function(s,h,a,_,l,u,p,c,f,g,y){y<0&&(y=-y),t.beginPath(),t.moveTo(a,_),t.arc(e,n,r,s,h,!1),"round"==i.arcEndCap?t.arc(.5*(p+f),.5*(c+g),y,h-Math.PI,h,!0):"-round"==i.arcEndCap?t.arc(.5*(p+f),.5*(c+g),y,h-Math.PI,h,!1):t.lineTo(f,g),t.arc(e,n,o,h,s,!0),"round"==i.arcStartCap?t.arc(.5*(a+l),.5*(_+u),y,s,s-Math.PI,!0):"-round"==i.arcStartCap?t.arc(.5*(a+l),.5*(_+u),y,s,s-Math.PI,!1):t.lineTo(a,_)}(s,s+h,g[0]+a,g[1]+_,g[4]+a,g[5]+_,g[2]+a,g[3]+_,g[6]+a,g[7]+_,.5*(u-l))}(s,h,e,n,r,o),"butt"==i.arcStartCap&&t.closePath(),t},g=function(t,i,e,n){return t.beginPath(),t.moveTo(i+n,e),t.arc(i,e,n,0,2*Math.PI),t},y=function(t,i,e,n,r){return t.beginPath(),t.rect(i,e,n,r),t};function d(t,i,e,n,r){for(var o=0,s="",h=0;h<i.length;h++)t.measureText(s+i[h]).width>e||/\n$/.test(s)?(r(s,((o+=1)-.5)*n),s=i[h]):h==i.length-1?(o+=1,r(s+i[h],(o-.5)*n)):s+=i[h];return o*n}var v=function(){function t(t,i,e,n,r){void 0===i&&(i={}),void 0===n&&(n=!1),this.__region=null,this.__onlyRegion=!1,this.__onlyView=!1,this.__specialConfig={fontSize:16,fontFamily:"sans-serif",fontWeight:400,fontStyle:"normal",arcStartCap:"butt",arcEndCap:"butt"},this.__initConfig={fillStyle:"black",strokeStyle:"black",lineWidth:1,textAlign:"left",textBaseline:"middle",lineDash:[],shadowBlur:0,shadowColor:"black"},this.painter=t.getContext("2d",i),this.__region=e,this.__isPainter=n,this.painter.textBaseline="middle",this.painter.textAlign="left"}return t.prototype.useConfig=function(t,i){if(this.__region&&!this.__onlyView&&["fillStyle","strokeStyle","shadowBlur","shadowColor"].indexOf(t)<0&&this.__region.useConfig(t,i),this.__isPainter&&this.__onlyRegion)return this;if("lineDash"==t)this.painter.setLineDash&&this.painter.setLineDash(i);else if(t in this.__specialConfig)"fontSize"==t&&(i=Math.round(i)),this.__specialConfig[t]=i;else{if(!(t in this.__initConfig))throw new Error("Illegal configuration item of painter : "+t+" !");this.painter[t]=i}return this},t.prototype.fillText=function(t,i,e,n){return void 0===n&&(n=0),this.__region&&!this.__onlyView&&this.__region.fillText(t,i,e,n),this.__isPainter&&this.__onlyRegion||(this.painter.save(),c(this.painter,this.__specialConfig,i,e,n).fillText(t,0,0),this.painter.restore()),this},t.prototype.strokeText=function(t,i,e,n){return void 0===n&&(n=0),this.__region&&!this.__onlyView&&this.__region.strokeText(t,i,e,n),this.__isPainter&&this.__onlyRegion||(this.painter.save(),c(this.painter,this.__specialConfig,i,e,n).strokeText(t,0,0),this.painter.restore()),this},t.prototype.fullText=function(t,i,e,n){return void 0===n&&(n=0),this.__region&&!this.__onlyView&&this.__region.fullText(t,i,e,n),this.__isPainter&&this.__onlyRegion||(this.painter.save(),c(this.painter,this.__specialConfig,i,e,n),this.painter.fillText(t,0,0),this.painter.strokeText(t,0,0),this.painter.restore()),this},t.prototype.fillTexts=function(t,i,e,n,r,o){var s=this;void 0===r&&(r=1.2),void 0===o&&(o=0);var h=0;if(this.__region&&!this.__onlyView&&(h=this.__region.fillTexts(t,i,e,n,r)),this.__isPainter&&this.__onlyRegion)return h;this.painter.save(),c(this.painter,this.__specialConfig,i,e,o);var a=d(this.painter,t,n,this.__specialConfig.fontSize*r,(function(t,i){s.painter.fillText(t,0,i)}));return this.painter.restore(),a},t.prototype.strokeTexts=function(t,i,e,n,r,o){var s=this;void 0===r&&(r=1.2),void 0===o&&(o=0);var h=0;if(this.__region&&!this.__onlyView&&(h=this.__region.fillTexts(t,i,e,n,r)),this.__isPainter&&this.__onlyRegion)return h;this.painter.save(),c(this.painter,this.__specialConfig,i,e,o);var a=d(this.painter,t,n,this.__specialConfig.fontSize*r,(function(t,i){s.painter.strokeText(t,0,i)}));return this.painter.restore(),a},t.prototype.fullTexts=function(t,i,e,n,r,o){var s=this;void 0===r&&(r=1.2),void 0===o&&(o=0);var h=0;if(this.__region&&!this.__onlyView&&(h=this.__region.fillTexts(t,i,e,n,r)),this.__isPainter&&this.__onlyRegion)return h;this.painter.save(),c(this.painter,this.__specialConfig,i,e,o);var a=d(this.painter,t,n,this.__specialConfig.fontSize*r,(function(t,i){s.painter.fillText(t,0,i),s.painter.strokeText(t,0,i)}));return this.painter.restore(),a},t.prototype.beginPath=function(){return this.__region&&!this.__onlyView&&this.__region.beginPath(),this.__isPainter&&this.__onlyRegion||this.painter.beginPath(),this},t.prototype.closePath=function(){return this.__region&&!this.__onlyView&&this.__region.closePath(),this.__isPainter&&this.__onlyRegion||this.painter.closePath(),this},t.prototype.moveTo=function(t,i){return this.__region&&!this.__onlyView&&this.__region.moveTo(t,i),this.__isPainter&&this.__onlyRegion||this.painter.moveTo(Math.round(t)+.5,Math.round(i)+.5),this},t.prototype.lineTo=function(t,i){return this.__region&&!this.__onlyView&&this.__region.lineTo(t,i),this.__isPainter&&this.__onlyRegion||this.painter.lineTo(Math.round(t)+.5,Math.round(i)+.5),this},t.prototype.arc=function(t,i,e,n,r){return this.__region&&!this.__onlyView&&this.__region.arc(t,i,e,n,r),this.__isPainter&&this.__onlyRegion||this.painter.arc(t,i,e,n,n+r,r<0),this},t.prototype.fill=function(){return this.__region&&!this.__onlyView&&this.__region.fill(),this.__isPainter&&this.__onlyRegion||this.painter.fill(),this},t.prototype.stroke=function(){return this.__region&&!this.__onlyView&&this.__region.stroke(),this.__isPainter&&this.__onlyRegion||this.painter.stroke(),this},t.prototype.full=function(){return this.__region&&!this.__onlyView&&this.__region.full(),this.__isPainter&&this.__onlyRegion||(this.painter.fill(),this.painter.stroke()),this},t.prototype.save=function(){return this.__region&&!this.__onlyView&&this.__region.save(),this.__isPainter&&this.__onlyRegion||this.painter.save(),this},t.prototype.restore=function(){return this.__region&&!this.__onlyView&&this.__region.restore(),this.__isPainter&&this.__onlyRegion||this.painter.restore(),this},t.prototype.clip=function(){return this.__region&&!this.__onlyView&&this.__region.clip(),this.__isPainter&&this.__onlyRegion||this.painter.clip(),this},t.prototype.quadraticCurveTo=function(t,i,e,n){return this.__region&&!this.__onlyView&&this.__region.quadraticCurveTo(t,i,e,n),this.__isPainter&&this.__onlyRegion||this.painter.quadraticCurveTo(t,i,e,n),this},t.prototype.bezierCurveTo=function(t,i,e,n,r,o){return this.__region&&!this.__onlyView&&this.__region.bezierCurveTo(t,i,e,n,r,o),this.__isPainter&&this.__onlyRegion||this.painter.bezierCurveTo(t,i,e,n,r,o),this},t.prototype.clearRect=function(t,i,e,n){return this.__region&&!this.__onlyView&&this.__region.clearRect(t,i,e,n),this.__isPainter&&this.__onlyRegion||this.painter.clearRect(t,i,e,n),this},t.prototype.fillArc=function(t,i,e,n,r,o){return this.__region&&!this.__onlyView&&this.__region.fillArc(t,i,e,n,r,o),this.__isPainter&&this.__onlyRegion||f(this.painter,this.__specialConfig,t,i,e,n,r,o).fill(),this},t.prototype.strokeArc=function(t,i,e,n,r,o){return this.__region&&!this.__onlyView&&this.__region.strokeArc(t,i,e,n,r,o),this.__isPainter&&this.__onlyRegion||f(this.painter,this.__specialConfig,t,i,e,n,r,o).stroke(),this},t.prototype.fullArc=function(t,i,e,n,r,o){return this.__region&&!this.__onlyView&&this.__region.fullArc(t,i,e,n,r,o),this.__isPainter&&this.__onlyRegion||(f(this.painter,this.__specialConfig,t,i,e,n,r,o),this.painter.fill(),this.painter.stroke()),this},t.prototype.fillCircle=function(t,i,e){return this.__region&&!this.__onlyView&&this.__region.fillCircle(t,i,e),this.__isPainter&&this.__onlyRegion||g(this.painter,t,i,e).fill(),this},t.prototype.strokeCircle=function(t,i,e){return this.__region&&!this.__onlyView&&this.__region.strokeCircle(t,i,e),this.__isPainter&&this.__onlyRegion||g(this.painter,t,i,e).stroke(),this},t.prototype.fullCircle=function(t,i,e){return this.__region&&!this.__onlyView&&this.__region.fullCircle(t,i,e),this.__isPainter&&this.__onlyRegion||(g(this.painter,t,i,e),this.painter.fill(),this.painter.stroke()),this},t.prototype.fillRect=function(t,i,e,n){return this.__region&&!this.__onlyView&&this.__region.fillRect(t,i,e,n),this.__isPainter&&this.__onlyRegion||y(this.painter,t,i,e,n).fill(),this},t.prototype.strokeRect=function(t,i,e,n){return this.__region&&!this.__onlyView&&this.__region.strokeRect(t,i,e,n),this.__isPainter&&this.__onlyRegion||y(this.painter,t,i,e,n).stroke(),this},t.prototype.fullRect=function(t,i,e,n){return this.__region&&!this.__onlyView&&this.__region.fullRect(t,i,e,n),this.__isPainter&&this.__onlyRegion||(y(this.painter,t,i,e,n),this.painter.fill(),this.painter.stroke()),this},t.prototype.draw=function(){return Promise.resolve()},t.prototype.drawImage=function(t,i,e,n,r,o){var s=this;return void 0===o&&(o=!1),new Promise((function(h){if(s.__region&&!s.__onlyView&&s.__region.fillRect(i,e,n,r),s.__isPainter&&s.__onlyRegion)h({});else if("string"!=typeof t||o)s.painter.drawImage(t,0,0,n,r,i,e,n,r),h({});else{var a=new Image;a.onload=function(){s.painter.drawImage(a,0,0,a.width,a.height,i,e,n,r),h({})},a.src=t}}))},t}(),w=function(t){var i={value:function(){return t},setColor:function(e,n){return t.addColorStop(e,n),i}};return i},P=function(t){function i(i,e,n,r){void 0===n&&(n={}),void 0===r&&(r=1);var o=t.call(this,i,n,e?new v(e,{willReadFrequently:!0}):void 0,!0,r)||this;return o.name="Canvas",o.__regionList={},o.__regionAssemble=function(t,i,e,n){for(var r=[],o=0;o<3;o++)r[o]=0;return function(){for(var t=0;t<3;t++){if(r[t]+10<255){r[t]=+(r[t]+10).toFixed(7);break}t<2&&(r[t]=0)}return r}}(),o.__scaleSize=r,o.setRegion(""),o}return function(t,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function e(){this.constructor=t}u(t,i),t.prototype=null===i?Object.create(i):(e.prototype=i.prototype,new e)}(i,t),i.prototype.config=function(t){for(var i in t)this.useConfig(i,t[i]);return this},i.prototype.onlyRegion=function(t){return this.__onlyRegion=t,this},i.prototype.onlyView=function(t){return this.__onlyView=t,this},i.prototype.setRegion=function(t){if(this.__region)if(t){if(null==this.__regionList[t]){var i=this.__regionAssemble();this.__regionList[t]="rgb("+i[0]+","+i[1]+","+i[2]+")"}this.__region.useConfig("fillStyle",this.__regionList[t])&&this.__region.useConfig("strokeStyle",this.__regionList[t])}else this.__region.useConfig("fillStyle","#000000")&&this.__region.useConfig("strokeStyle","#000000");return this},i.prototype.getRegion=function(t,i){var e=this;return new Promise((function(n){var r=e.__region?e.__region.painter.getImageData(t-.5,i-.5,1,1):{data:[0,0,0,0]},o=r.data,s=function(){if(e.__region)for(var t in e.__regionList)if("rgb("+o[0]+","+o[1]+","+o[2]+")"==e.__regionList[t]){n(t);break}n("")};o?s():r.then((function(t){o=t,s()}))}))},i.prototype.textWidth=function(t){this.painter.save(),c(this.painter,this.__specialConfig,0,0,0);var i=this.painter.measureText(t+"").width;return this.painter.restore(),i},i.prototype.getContext=function(t){return void 0===t&&(t=!1),t?this.__region?this.__region.painter:null:this.painter},i.prototype.getInfo=function(){return{width:this.painter.canvas.width/this.__scaleSize,height:this.painter.canvas.height/this.__scaleSize}},i.prototype.createLinearGradient=function(t,i,e,n){return r=this.painter,o=t,s=i,h=e,a=n,_=r.createLinearGradient(o,s,h,a),w(_);var r,o,s,h,a,_},i.prototype.createRadialGradient=function(t,i,e){return n=this.painter,r=t,o=i,s=e,h=n.createRadialGradient(r,o,0,r,o,s),w(h);var n,r,o,s,h},i.prototype.getColor=function(t,i){t*=this.__scaleSize,i*=this.__scaleSize;var e=this.painter.getImageData(t-.5,i-.5,1,1).data;return"rgba("+e[0]+","+e[1]+","+e[2]+","+e[3]+")"},i}(v);const C=l({data:()=>({uniqueid:(1e4*Math.random()).toFixed(0),help:{},viewImg:"",isH5:!0,hadFetch:!1}),props:{width:{type:Number,default:300},height:{type:Number,default:150},cover:{type:Boolean,default:!0},region:{type:Boolean,default:!0}},methods:{fetch(){let t,i,e,n;t=uni.createCanvasContext("painter-"+this.uniqueid,this),this.region&&(i=uni.createCanvasContext("region-"+this.uniqueid,this)),e="painter-"+this.uniqueid,n="region-"+this.uniqueid;let r=this;return this.help.instance=new P({getContext:()=>t},r.region?{getContext:()=>(i.getImageData=(t,i,e,o)=>new Promise(((s,h)=>{let a={x:t,y:i,width:e,height:o,canvasId:n,success:function(t){s(t.data)},fail:function(t){h(t)}};uni.canvasGetImageData(a,r)})),i)}:null,1),this.help.instance.draw=(n=!1,o=(()=>{}))=>{t.draw(n,(()=>{this.cover||this.isH5?(r.region&&i.draw(n),o()):uni.canvasToTempFilePath({canvasId:e,success:t=>{this.viewImg=t.tempFilePath,r.region&&i.draw(n),o()}},this)}))},this.hadFetch=!0,new Promise(((t,i)=>{this.help.instance.toDataURL=()=>new Promise((t=>{uni.canvasToTempFilePath({canvasId:e,success:function(i){t(i.tempFilePath)}},this)})),this.help.instance.drawImage=function(t,i){return function(e,n,r,o,s){return new Promise((h=>{/^http/.test(e)?uni.downloadFile({url:e,success:function(e){i.call(t,e.tempFilePath,n,r,o,s,!0).then((()=>{h({})}))}}):i.call(t,e,n,r,o,s,!0).then((()=>{h({})}))}))}}(this.help.instance,this.help.instance.drawImage),t(this.help.instance)}))},doit(t){let i=(t,i)=>{this.help.instance.getRegion(t,i).then((e=>{this.$emit("dotouchstart",{name:e,x:t,y:i})}))};if(this.cover||this.isH5){let e=t.touches[0].x,n=t.touches[0].y;i(e,n)}else uni.createSelectorQuery().selectViewport().scrollOffset().exec((e=>{uni.createSelectorQuery().in(this).select(".view-"+this.uniqueid).boundingClientRect((n=>{i(t.touches[0].pageX-n.left-e[0].scrollLeft,t.touches[0].pageY-n.top-e[0].scrollTop)})).exec()}))},doitstart(t){this.doit(t)}}},[["render",function(l,u,p,c,f,g){const y=h,d=a,v=_;return t(),i(d,{class:n(p.cover||f.isH5?"cover-view":"normal-view"),style:{display:"inline-block"}},{default:e((()=>[p.cover||f.isH5?s("",!0):(t(),i(d,{key:0,class:n("view-img view-"+f.uniqueid),onTouchstart:g.doitstart},{default:e((()=>[r(y,{style:o({width:p.width+"px",height:p.height+"px"}),src:f.viewImg},null,8,["style","src"])])),_:1},8,["class","onTouchstart"])),r(v,{class:"painter","canvas-id":"painter-"+f.uniqueid,onTouchstart:g.doitstart,style:o([{width:p.width+"px",height:p.height+"px"},p.cover||f.isH5?{}:{position:"fixed",left:"50000px"}])},null,8,["canvas-id","onTouchstart","style"]),p.region?(t(),i(v,{key:1,class:"region","canvas-id":"region-"+f.uniqueid,style:o({width:p.width+"px",height:p.height+"px",position:"fixed",left:"50000px"})},null,8,["canvas-id","style"])):s("",!0)])),_:1},8,["class"])}]]);export{C as V};
